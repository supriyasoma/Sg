import * as moment from 'moment';

describe('BluebookPidV2Component', () => {
  let component: BluebookPidV2Component;
  let fixture: ComponentFixture<BluebookPidV2Component>;
  let bluebookPidV2Service: jasmine.SpyObj<BluebookPidV2Service>;

  beforeEach(async () => {
    // Mock BluebookPidV2Service methods
    bluebookPidV2Service = jasmine.createSpyObj('BluebookPidV2Service', ['getBanks', 'getIndicators', 'generateReport']);
    bluebookPidV2Service.getBanks.and.returnValue(of([]));
    bluebookPidV2Service.generateReport.and.returnValue(of({}));

    await TestBed.configureTestingModule({
      imports: [
        HttpClientTestingModule,
        ToastrModule.forRoot({ positionClass: 'toast-top-full-width' }),
        TranslateModule.forRoot({
          loader: { provide: TranslateLoader, useClass: TranslateFakeLoader }
        })
      ],
      providers: [
        { provide: BluebookPidV2Service, useValue: bluebookPidV2Service },
        FormBuilder
      ],
      declarations: [BluebookPidV2Component],
      schemas: [CUSTOM_ELEMENTS_SCHEMA, NO_ERRORS_SCHEMA]
    }).compileComponents();
  });

  beforeEach(() => {
    fixture = TestBed.createComponent(BluebookPidV2Component);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should generate report with properly formatted startDate and endDate', () => {
    const mockStartDate = '2023-01-15';
    const mockEndDate = '2023-12-15';

    // Mock moment to control the output for startOf and endOf
    spyOn(moment.prototype, 'startOf').and.returnValue(moment('2023-01-01'));
    spyOn(moment.prototype, 'endOf').and.returnValue(moment('2023-12-31'));

    component.form.setValue({
      bank: { bic: 'BANK1', code: '001', name: 'Bank One' },
      startDate: mockStartDate,
      endDate: mockEndDate
    });

    // Call generateReport
    component.generateReport('pdf');

    // Verify the service call with formatted dates
    expect(bluebookPidV2Service.generateReport).toHaveBeenCalledWith(
      jasmine.objectContaining({
        biccode: 'BANK1',
        startDate: '2023-01-01',
        endDate: '2023-12-31'
      }),
      'pdf'
    );
  });
});
